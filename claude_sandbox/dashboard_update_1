1. Replace dashboard/app.py with this

This keeps your current behavior (echo payload) and adds real hooks into the PRISM scripts using subprocess.

# dashboard/app.py
from __future__ import annotations

import json
import os
import subprocess
import sys
from pathlib import Path
from typing import Any, Dict, List

from flask import Flask, render_template, request, jsonify

# -----------------------------------------------------------------------------
# Paths
# -----------------------------------------------------------------------------
BASE_DIR = Path(__file__).resolve().parents[1]
START_DIR = BASE_DIR / "start"
DIAG_DIR = BASE_DIR / "diagnostics"
OUTPUT_DIR = Path(
    os.environ.get(
        "PRISM_OUTPUT_DIR",
        str(
            Path.home()
            / "Library"
            / "CloudStorage"
            / "GoogleDrive-rudder.jason@gmail.com"
            / "My Drive"
            / "prism_output"
        ),
    )
)

app = Flask(
    __name__,
    template_folder=str(BASE_DIR / "dashboard" / "templates"),
    static_folder=str(BASE_DIR / "dashboard" / "static"),
)

# -----------------------------------------------------------------------------
# Helpers
# -----------------------------------------------------------------------------


def run_python_script(script_path: Path, args: List[str] | None = None) -> Dict[str, Any]:
    """
    Run a Python script in the current virtualenv and capture stdout/stderr.
    Returns a dict {returncode, stdout, stderr}.
    """
    if args is None:
        args = []

    cmd = [sys.executable, str(script_path), *args]

    try:
        proc = subprocess.run(
            cmd,
            cwd=str(BASE_DIR),
            capture_output=True,
            text=True,
            timeout=60 * 60,  # 1 hour max, just to be safe
        )
        return {
            "returncode": proc.returncode,
            "stdout": proc.stdout,
            "stderr": proc.stderr,
        }
    except subprocess.TimeoutExpired as exc:
        return {
            "returncode": -1,
            "stdout": exc.stdout or "",
            "stderr": f"TimeoutExpired: {exc}",
        }
    except Exception as exc:  # noqa: BLE001
        return {
            "returncode": -1,
            "stdout": "",
            "stderr": f"Exception when running {script_path}: {exc}",
        }


def summarize_result(label: str, result: Dict[str, Any]) -> Dict[str, Any]:
    """Small helper to normalize result blocks for the UI."""
    status = "ok"
    if result["returncode"] != 0:
        status = "error"

    # Trim long outputs a bit for JSON payload
    def _trim(text: str, limit: int = 4000) -> str:
        if len(text) <= limit:
            return text
        return text[:limit] + "\n\n...[truncated]..."

    return {
        "label": label,
        "status": status,
        "returncode": result["returncode"],
        "stdout": _trim(result.get("stdout", "")),
        "stderr": _trim(result.get("stderr", "")),
    }


# -----------------------------------------------------------------------------
# Routes
# -----------------------------------------------------------------------------


@app.route("/")
def index():
    """
    Main dashboard page.
    The form controls are in dashboard/templates/dashboard.html.
    """
    return render_template("dashboard.html")


@app.route("/api/run", methods=["POST"])
def run_controller():
    """
    Central PRISM controller endpoint.

    Expects JSON like:
    {
      "analysis": "coherence",
      "diagnostics": "db",
      "fetch_source": ["fred"],
      "fetch_range": "30d",
      "mlmeta": "none",
      "systems": ["market"]
    }
    """
    payload = request.get_json(force=True) or {}
    analysis = payload.get("analysis")
    diagnostics_mode = payload.get("diagnostics")
    fetch_sources = payload.get("fetch_source", [])
    fetch_range = payload.get("fetch_range", "30d")
    mlmeta_mode = payload.get("mlmeta", "none")
    systems = payload.get("systems", [])

    results: Dict[str, Any] = {
        "payload_received": payload,
        "actions": [],
    }

    # ------------------------------------------------------
    # 1) Optional: run diagnostics
    # ------------------------------------------------------
    if diagnostics_mode and diagnostics_mode != "none":
        diag_script = DIAG_DIR / "run_diagnostics.py"
        if diag_script.exists():
            diag_args: List[str] = []
            if diagnostics_mode == "full":
                diag_args = []
            elif diagnostics_mode == "db":
                diag_args = ["--only", "database"]
            elif diagnostics_mode == "engine":
                diag_args = ["--only", "engine"]

            r = run_python_script(diag_script, diag_args)
            results["actions"].append(
                summarize_result("diagnostics", r),
            )
        else:
            results["actions"].append(
                {
                    "label": "diagnostics",
                    "status": "missing",
                    "message": f"{diag_script} not found",
                }
            )

    # ------------------------------------------------------
    # 2) Optional: fetch data
    # (For now we just note the intent; Claude can later
    #  wire this to start/update_all.py with src filters.)
    # ------------------------------------------------------
    if fetch_sources:
        # Placeholder for Claude / future:
        # Could pass --source fred,tiingo etc. to update_all.py
        results["actions"].append(
            {
                "label": "fetch",
                "status": "skipped",
                "message": (
                    "Fetch requested for sources="
                    f"{', '.join(fetch_sources)} (range={fetch_range}), "
                    "but fetch wiring is intentionally disabled here to "
                    "avoid hammering APIs. Implement in start/update_all.py "
                    "with source filters."
                ),
            }
        )

    # ------------------------------------------------------
    # 3) Run analysis
    # ------------------------------------------------------
    if analysis == "coherence":
        script = START_DIR / "run_coherance.py"
        if script.exists():
            r = run_python_script(script)
            results["actions"].append(
                summarize_result("coherence", r),
            )
        else:
            results["actions"].append(
                {
                    "label": "coherence",
                    "status": "missing",
                    "message": f"{script} not found",
                }
            )

    elif analysis == "correlation":
        script = START_DIR / "run_correlation.py"
        if script.exists():
            r = run_python_script(script)
            results["actions"].append(
                summarize_result("correlation", r),
            )
        else:
            results["actions"].append(
                {
                    "label": "correlation",
                    "status": "missing",
                    "message": f"{script} not found",
                }
            )

    elif analysis == "calibrated":
        script = START_DIR / "run_calibrated.py"
        if script.exists():
            r = run_python_script(script)
            results["actions"].append(
                summarize_result("calibrated", r),
            )
        else:
            results["actions"].append(
                {
                    "label": "calibrated",
                    "status": "missing",
                    "message": f"{script} not found",
                }
            )

    elif analysis == "none" or not analysis:
        results["actions"].append(
            {
                "label": "analysis",
                "status": "skipped",
                "message": "No analysis selected.",
            }
        )

    else:
        results["actions"].append(
            {
                "label": "analysis",
                "status": "unknown",
                "message": f"Unknown analysis mode: {analysis}",
            }
        )

    # ------------------------------------------------------
    # 4) ML / Meta mode – placeholder for now
    # ------------------------------------------------------
    if mlmeta_mode and mlmeta_mode != "none":
        results["actions"].append(
            {
                "label": "mlmeta",
                "status": "todo",
                "message": (
                    f"ML/Meta mode '{mlmeta_mode}' selected; "
                    "hook this into hidden_variation_detector + meta-engine "
                    "when ready."
                ),
            }
        )

    # ------------------------------------------------------
    # 5) System selection – just echo back for now
    # ------------------------------------------------------
    if systems:
        results["systems_used"] = systems

    return jsonify(
        {
            "status": "ok",
            "message": "PRISM controller executed.",
            "result": results,
        }
    )


if __name__ == "__main__":
    # Run dev server
    app.run(host="127.0.0.1", port=5000, debug=True)


That gives Claude all the hooks he needs:

Clear run_python_script helper

Separate blocks per feature

Safe “skipped/todo” stubs where behavior isn’t ready yet

2. Minimal Tabler-style front-end shell

If your dashboard/templates/dashboard.html is still just a basic form, you can give Claude this as the shape to converge on (he can merge with what’s already there).

This assumes a dark Tabler-ish theme and your PRISM logo at /static/img/prism-logo-dark.png.

{# dashboard/templates/dashboard.html #}
{% extends "base.html" %}
{% block content %}
<div class="page">
  <div class="page-main">
    <div class="container-xl py-4">

      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
          <img src="{{ url_for('static', filename='img/prism-logo-dark.png') }}"
               alt="PRISM" style="height:40px;" class="me-3">
          <div>
            <h2 class="page-title mb-1">PRISM Controller</h2>
            <div class="text-secondary">
              Unified geometric model of equilibrium
            </div>
          </div>
        </div>
      </div>

      <div class="row row-cards">
        <!-- Left: Controls -->
        <div class="col-md-4">
          <form id="prism-form" class="card card-md">
            <div class="card-header">
              <h3 class="card-title">Run configuration</h3>
            </div>
            <div class="card-body">

              <!-- Diagnostics -->
              <div class="mb-3">
                <label class="form-label">Diagnostics</label>
                <select class="form-select" name="diagnostics">
                  <option value="none" selected>None</option>
                  <option value="full">Full system check</option>
                  <option value="db">Database only</option>
                  <option value="engine">Engine only</option>
                </select>
              </div>

              <!-- Analysis -->
              <div class="mb-3">
                <label class="form-label">Analysis</label>
                <select class="form-select" name="analysis">
                  <option value="none" selected>None</option>
                  <option value="coherence">Coherence</option>
                  <option value="correlation">Correlation</option>
                  <option value="calibrated">Calibrated engine</option>
                </select>
              </div>

              <!-- Fetch -->
              <div class="mb-3">
                <label class="form-label">Data fetch (optional)</label>
                <div class="form-selectgroup form-selectgroup-pills">
                  <label class="form-selectgroup-item">
                    <input type="checkbox" name="fetch_source" value="fred"
                           class="form-selectgroup-input">
                    <span class="form-selectgroup-label">FRED</span>
                  </label>
                  <label class="form-selectgroup-item">
                    <input type="checkbox" name="fetch_source" value="tiingo"
                           class="form-selectgroup-input">
                    <span class="form-selectgroup-label">Tiingo</span>
                  </label>
                  <label class="form-selectgroup-item">
                    <input type="checkbox" name="fetch_source" value="climate"
                           class="form-selectgroup-input" disabled>
                    <span class="form-selectgroup-label">Climate (frozen)</span>
                  </label>
                </div>
                <small class="form-hint">
                  Warning: Tiingo has rate limits. Use sparingly.
                </small>
              </div>

              <div class="mb-3">
                <label class="form-label">Fetch range</label>
                <select class="form-select" name="fetch_range">
                  <option value="30d">Last 30 days</option>
                  <option value="90d">Last 90 days</option>
                  <option value="full">Full history</option>
                </select>
              </div>

              <!-- ML / Meta -->
              <div class="mb-3">
                <label class="form-label">ML / Meta</label>
                <select class="form-select" name="mlmeta">
                  <option value="none" selected>None</option>
                  <option value="ml">ML only</option>
                  <option value="meta">Meta only</option>
                  <option value="both">ML + Meta</option>
                </select>
              </div>

              <!-- Systems -->
              <div class="mb-3">
                <label class="form-label">Systems</label>
                <div class="form-selectgroup form-selectgroup-pills">
                  <label class="form-selectgroup-item">
                    <input type="checkbox" name="systems" value="market"
                           class="form-selectgroup-input" checked>
                    <span class="form-selectgroup-label">Market</span>
                  </label>
                  <label class="form-selectgroup-item">
                    <input type="checkbox" name="systems" value="liquidity"
                           class="form-selectgroup-input">
                    <span class="form-selectgroup-label">Liquidity</span>
                  </label>
                  <label class="form-selectgroup-item">
                    <input type="checkbox" name="systems" value="credit"
                           class="form-selectgroup-input">
                    <span class="form-selectgroup-label">Credit</span>
                  </label>
                  <label class="form-selectgroup-item">
                    <input type="checkbox" name="systems" value="climate"
                           class="form-selectgroup-input" disabled>
                    <span class="form-selectgroup-label">Climate</span>
                  </label>
                </div>
              </div>

            </div>
            <div class="card-footer d-flex justify-content-between align-items-center">
              <div class="text-secondary small" id="run-status">
                Ready.
              </div>
              <button type="submit" class="btn btn-primary" id="run-button">
                Run PRISM
              </button>
            </div>
          </form>
        </div>

        <!-- Right: Results -->
        <div class="col-md-8">
          <div class="card card-md">
            <div class="card-header">
              <h3 class="card-title">Run output</h3>
            </div>
            <div class="card-body">
              <pre id="output-json" class="code-block mb-3">
Waiting for run...
              </pre>
              <div id="output-actions"></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}


And a very small JS helper (if you don’t already have one) in dashboard/static/dashboard.js:

// dashboard/static/dashboard.js
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("prism-form");
  const runButton = document.getElementById("run-button");
  const runStatus = document.getElementById("run-status");
  const outputJson = document.getElementById("output-json");
  const outputActions = document.getElementById("output-actions");

  if (!form) return;

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    runButton.disabled = true;
    runStatus.textContent = "Running...";
    outputActions.innerHTML = "";

    const formData = new FormData(form);

    const payload = {
      diagnostics: formData.get("diagnostics"),
      analysis: formData.get("analysis"),
      fetch_range: formData.get("fetch_range"),
      mlmeta: formData.get("mlmeta"),
      fetch_source: formData.getAll("fetch_source"),
      systems: formData.getAll("systems"),
    };

    try {
      const res = await fetch("/api/run", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload),
      });
      const data = await res.json();

      outputJson.textContent = JSON.stringify(data, null, 2);

      if (data.result && Array.isArray(data.result.actions)) {
        data.result.actions.forEach((action) => {
          const card = document.createElement("div");
          card.className = "card mb-3";

          const statusBadge = `<span class="badge ${
            action.status === "ok"
              ? "bg-green"
              : action.status === "warning"
              ? "bg-yellow"
              : "bg-red"
          }">${action.status}</span>`;

          card.innerHTML = `
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>${action.label || "action"}</span>
              ${statusBadge}
            </div>
            <div class="card-body">
              ${
                action.message
                  ? `<p class="mb-2 text-secondary">${action.message}</p>`
                  : ""
              }
              ${
                action.stdout
                  ? `<details class="mb-2"><summary>stdout</summary><pre>${escapeHtml(
                      action.stdout
                    )}</pre></details>`
                  : ""
              }
              ${
                action.stderr
                  ? `<details class="mb-0"><summary>stderr</summary><pre>${escapeHtml(
                      action.stderr
                    )}</pre></details>`
                  : ""
              }
            </div>
          `;
          outputActions.appendChild(card);
        });
      }

      runStatus.textContent = "Run complete.";
    } catch (err) {
      outputJson.textContent = `Request failed: ${err}`;
      runStatus.textContent = "Error.";
    } finally {
      runButton.disabled = false;
    }
  });

  function escapeHtml(str) {
    return str
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }
});


Your base.html just needs to:
