{% extends "base.html" %}

{% block title %}PRISM Diagnostics{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <span class="card-icon">ðŸ”¬</span>
        <div>
            <div class="card-title">System Diagnostics</div>
            <div class="card-description">Health and performance checks for PRISM Engine</div>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-error">
        <span class="alert-icon">!</span>
        <div>
            <strong>Error running diagnostics</strong>
            <p>{{ error }}</p>
        </div>
    </div>
    {% elif results %}

    <!-- Summary Cards -->
    <div class="grid grid-3" style="margin-bottom: 1.5rem;">
        <div class="card" style="text-align: center; {% if results.summary.all_passed %}border-left: 4px solid var(--success);{% else %}border-left: 4px solid var(--danger);{% endif %}">
            <div style="font-size: 2.5rem; font-weight: bold;">
                {% if results.summary.all_passed %}
                <span style="color: var(--success);">PASS</span>
                {% else %}
                <span style="color: var(--danger);">ISSUES</span>
                {% endif %}
            </div>
            <div class="text-muted">Overall Status</div>
        </div>
        <div class="card" style="text-align: center;">
            <div style="font-size: 2.5rem; font-weight: bold; color: var(--success);">{{ results.summary.passed }}</div>
            <div class="text-muted">Passed</div>
        </div>
        <div class="card" style="text-align: center;">
            <div style="font-size: 2.5rem; font-weight: bold; color: var(--danger);">{{ results.summary.failed + results.summary.errors }}</div>
            <div class="text-muted">Failed/Errors</div>
        </div>
    </div>

    <!-- Statistics Row -->
    <div class="grid" style="grid-template-columns: repeat(6, 1fr); gap: 0.5rem; margin-bottom: 1.5rem;">
        <div style="text-align: center; padding: 0.75rem; background: var(--bg); border-radius: var(--radius-sm);">
            <div style="font-weight: bold;">{{ results.summary.total }}</div>
            <div class="text-muted" style="font-size: 0.75rem;">Total</div>
        </div>
        <div style="text-align: center; padding: 0.75rem; background: var(--success-light); border-radius: var(--radius-sm);">
            <div style="font-weight: bold; color: #166534;">{{ results.summary.passed }}</div>
            <div class="text-muted" style="font-size: 0.75rem;">Passed</div>
        </div>
        <div style="text-align: center; padding: 0.75rem; background: var(--danger-light); border-radius: var(--radius-sm);">
            <div style="font-weight: bold; color: #991b1b;">{{ results.summary.failed }}</div>
            <div class="text-muted" style="font-size: 0.75rem;">Failed</div>
        </div>
        <div style="text-align: center; padding: 0.75rem; background: var(--warning-light); border-radius: var(--radius-sm);">
            <div style="font-weight: bold; color: #92400e;">{{ results.summary.warnings }}</div>
            <div class="text-muted" style="font-size: 0.75rem;">Warnings</div>
        </div>
        <div style="text-align: center; padding: 0.75rem; background: var(--bg); border-radius: var(--radius-sm);">
            <div style="font-weight: bold;">{{ results.summary.skipped }}</div>
            <div class="text-muted" style="font-size: 0.75rem;">Skipped</div>
        </div>
        <div style="text-align: center; padding: 0.75rem; background: var(--bg); border-radius: var(--radius-sm);">
            <div style="font-weight: bold;">{{ "%.0f"|format(results.summary.total_duration_ms) }}ms</div>
            <div class="text-muted" style="font-size: 0.75rem;">Duration</div>
        </div>
    </div>

    <!-- Results by Category -->
    {% for category, cat_results in results.by_category.items() %}
    <div class="card" style="margin-top: 1rem;">
        <div class="card-header">
            <span class="card-icon">
                {% if category == 'health' %}ðŸ’š
                {% elif category == 'system' %}ðŸ’»
                {% elif category == 'performance' %}âš¡
                {% elif category == 'validation' %}âœ…
                {% else %}ðŸ“‹{% endif %}
            </span>
            <div>
                <div class="card-title">{{ category|title }}</div>
                <div class="card-description">{{ cat_results|length }} diagnostic(s)</div>
            </div>
        </div>

        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 2px solid var(--border);">
                    <th style="text-align: left; padding: 0.75rem; color: var(--text-muted); font-weight: 600;">Diagnostic</th>
                    <th style="text-align: center; padding: 0.75rem; color: var(--text-muted); font-weight: 600;">Status</th>
                    <th style="text-align: right; padding: 0.75rem; color: var(--text-muted); font-weight: 600;">Duration</th>
                    <th style="text-align: left; padding: 0.75rem; color: var(--text-muted); font-weight: 600;">Message</th>
                </tr>
            </thead>
            <tbody>
                {% for result in cat_results %}
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 0.75rem; font-weight: 500;">{{ result.name }}</td>
                    <td style="padding: 0.75rem; text-align: center;">
                        {% if result.status == 'pass' %}
                        <span class="badge badge-success">PASS</span>
                        {% elif result.status == 'fail' %}
                        <span class="badge badge-danger">FAIL</span>
                        {% elif result.status == 'warn' %}
                        <span class="badge badge-warning">WARN</span>
                        {% elif result.status == 'error' %}
                        <span class="badge badge-danger">ERROR</span>
                        {% elif result.status == 'skip' %}
                        <span class="badge" style="background: var(--bg); color: var(--text-muted);">SKIP</span>
                        {% else %}
                        <span class="badge">{{ result.status|upper }}</span>
                        {% endif %}
                    </td>
                    <td style="padding: 0.75rem; text-align: right; color: var(--text-muted);">{{ "%.0f"|format(result.duration_ms) }}ms</td>
                    <td style="padding: 0.75rem; color: var(--text-muted); font-size: 0.875rem;">{{ result.message[:80] }}{% if result.message|length > 80 %}...{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endfor %}

    <!-- Failed Details -->
    {% set failed_results = results.results | selectattr('status', 'in', ['fail', 'error']) | list %}
    {% if failed_results %}
    <div class="card" style="margin-top: 1.5rem; border-left: 4px solid var(--danger);">
        <div class="card-header">
            <span class="card-icon">!</span>
            <div>
                <div class="card-title">Failed Diagnostics Details</div>
                <div class="card-description">{{ failed_results|length }} issue(s) require attention</div>
            </div>
        </div>

        {% for result in failed_results %}
        <div style="padding: 1rem; background: var(--bg); border-radius: var(--radius-sm); margin-bottom: 1rem;">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">{{ result.name }}</div>
            <div style="color: var(--danger); margin-bottom: 0.5rem;">{{ result.message }}</div>
            {% if result.suggestions %}
            <div style="font-size: 0.875rem; color: var(--text-muted);">
                <strong>Suggestions:</strong>
                <ul style="margin: 0.5rem 0 0 1.5rem;">
                    {% for suggestion in result.suggestions %}
                    <li>{{ suggestion }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% else %}
    <p class="text-muted">No results available. Run diagnostics to see results.</p>
    {% endif %}
</div>

<!-- Quick Actions -->
<div class="card">
    <div class="card-header">
        <span class="card-icon">âš¡</span>
        <div>
            <div class="card-title">Run Diagnostics</div>
            <div class="card-description">Select options and re-run</div>
        </div>
    </div>

    <div class="grid grid-2">
        <a href="/diagnostics?quick=true" class="btn btn-secondary btn-block">
            ðŸš€ Quick Diagnostics
        </a>
        <a href="/diagnostics" class="btn btn-primary btn-block">
            ðŸ”¬ Full Diagnostics
        </a>
    </div>

    <div class="grid grid-3" style="margin-top: 1rem;">
        <a href="/diagnostics?category=health" class="btn btn-secondary btn-block">
            ðŸ’š Health Only
        </a>
        <a href="/diagnostics?category=performance" class="btn btn-secondary btn-block">
            âš¡ Performance Only
        </a>
        <a href="/diagnostics?category=validation" class="btn btn-secondary btn-block">
            âœ… Validation Only
        </a>
    </div>
</div>

<div class="footer">
    <p class="text-muted">Generated: {{ timestamp }}</p>
</div>
{% endblock %}
