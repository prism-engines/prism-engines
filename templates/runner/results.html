{% extends "base.html" %}

{% block title %}PRISM Results{% endblock %}

{% block content %}

{% if success %}
<!-- Success State -->
<div class="alert alert-success">
    <span class="alert-icon">âœ…</span>
    <div>
        <strong>Analysis Complete!</strong>
        <span>Completed in {{ "%.1f"|format(results.duration) }} seconds</span>
    </div>
</div>

<div class="grid grid-2">
    <!-- Report Link -->
    <div class="card result-card success">
        <div class="card-header">
            <span class="card-icon">ğŸ“„</span>
            <div>
                <div class="card-title">Analysis Report</div>
                <div class="card-description">View the generated HTML report</div>
            </div>
        </div>

        {% if results.report_path %}
        <a href="/output/{{ results.report_path | replace(results.output_dir ~ '/', '') }}"
           target="_blank" class="result-link">
            <span>ğŸ“Š</span>
            <span>Open Report</span>
            <span style="margin-left: auto;">â†—ï¸</span>
        </a>
        {% else %}
        <p class="text-muted">No report generated</p>
        {% endif %}
    </div>

    <!-- Output Folder -->
    <div class="card result-card success">
        <div class="card-header">
            <span class="card-icon">ğŸ“</span>
            <div>
                <div class="card-title">Output Folder</div>
                <div class="card-description">All generated files</div>
            </div>
        </div>

        <div class="result-link" style="cursor: default;">
            <span>ğŸ“‚</span>
            <code style="font-size: 0.875rem; color: var(--text-muted);">
                {{ results.output_dir | default('output/') }}
            </code>
        </div>
    </div>
</div>

<!-- Comparison Results (for regime_comparison) -->
{% if results.comparisons %}
<div class="card">
    <div class="card-header">
        <span class="card-icon">ğŸ“ˆ</span>
        <div>
            <div class="card-title">Similarity Rankings</div>
            <div class="card-description">How similar is the current period to historical regimes?</div>
        </div>
    </div>

    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="border-bottom: 2px solid var(--border);">
                <th style="text-align: left; padding: 0.75rem;">Period</th>
                <th style="text-align: left; padding: 0.75rem;">Similarity</th>
                <th style="text-align: left; padding: 0.75rem;">Visual</th>
            </tr>
        </thead>
        <tbody>
            {% for period, data in results.comparisons.items() %}
            {% set similarity = data.overall_similarity if data.overall_similarity is defined else data.similarity if data.similarity is defined else 0 %}
            <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 0.75rem;">
                    <strong>{{ period | replace('_', ' ') | title }}</strong>
                </td>
                <td style="padding: 0.75rem;">
                    <span class="badge {% if similarity > 0.7 %}badge-success{% elif similarity > 0.5 %}badge-warning{% else %}badge-danger{% endif %}">
                        {{ "%.1f"|format(similarity * 100) }}%
                    </span>
                </td>
                <td style="padding: 0.75rem; width: 40%;">
                    <div style="height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; width: {{ similarity * 100 }}%;
                                    background: {% if similarity > 0.7 %}var(--success){% elif similarity > 0.5 %}var(--warning){% else %}var(--danger){% endif %};
                                    border-radius: 4px;"></div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% else %}
<!-- Error State -->
<div class="alert alert-error">
    <span class="alert-icon">âŒ</span>
    <div>
        <strong>Analysis Failed</strong>
        <span>{{ error }}</span>
    </div>
</div>

<div class="card result-card error">
    <div class="card-header">
        <span class="card-icon">âš ï¸</span>
        <div>
            <div class="card-title">Error Details</div>
            <div class="card-description">The analysis encountered an error</div>
        </div>
    </div>

    <div style="background: var(--bg); padding: 1rem; border-radius: var(--radius-sm); font-family: monospace; font-size: 0.875rem; overflow-x: auto;">
        {{ error }}
    </div>
</div>
{% endif %}

<!-- Configuration Summary -->
<div class="card">
    <div class="card-header">
        <span class="card-icon">âš™ï¸</span>
        <div>
            <div class="card-title">Configuration</div>
            <div class="card-description">Settings used for this analysis</div>
        </div>
    </div>

    <div class="grid grid-3">
        <div>
            <div class="text-muted" style="font-size: 0.875rem;">Panel</div>
            <div style="font-weight: 600;">{{ params.panel | title }}</div>
        </div>
        <div>
            <div class="text-muted" style="font-size: 0.875rem;">Workflow</div>
            <div style="font-weight: 600;">{{ params.workflow | replace('_', ' ') | title }}</div>
        </div>
        <div>
            <div class="text-muted" style="font-size: 0.875rem;">Weighting</div>
            <div style="font-weight: 600;">{{ params.weighting | title }}</div>
        </div>
    </div>

    {% if params.comparison_periods %}
    <div class="mt-2">
        <div class="text-muted" style="font-size: 0.875rem;">Comparison Periods</div>
        <div>
            {% for period in params.comparison_periods %}
            <span class="badge badge-primary" style="margin-right: 0.5rem;">{{ period | replace('_', ' ') }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Actions -->
<div class="card">
    <div style="display: flex; gap: 1rem; justify-content: center;">
        <a href="/" class="btn btn-primary">
            â† Run Another Analysis
        </a>
        <a href="/reports" class="btn btn-secondary">
            View All Reports
        </a>
    </div>
</div>

{% endblock %}
